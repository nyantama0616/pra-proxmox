---
- name: Install Strapi prerequisites
  ansible.builtin.apt:
    name:
      - git
    state: present

- name: Clone repository
  ansible.builtin.git:
    repo: https://github.com/nyantama0616/pra-proxmox.git
    dest: /opt/pra-proxmox
    version: main

- name: Deploy Strapi .env
  ansible.builtin.template:
    src: strapi.env.j2
    dest: /opt/pra-proxmox/cms/.env
    mode: "0600"

- name: Install pnpm dependencies
  ansible.builtin.shell: |
    export PATH="/root/.local/share/fnm:$PATH"
    eval "$(fnm env)"
    pnpm install
  args:
    chdir: /opt/pra-proxmox/cms

# Note: pnpm installではbetter-sqlite3のネイティブバインディング(.nodeファイル)が生成されない。
# pnpm rebuildもpnpmの.pnpmストア構造の影響で正しくビルドされない。
# そのため、パッケージディレクトリ内で直接node-gyp rebuildを実行する必要がある。
- name: Rebuild better-sqlite3 native module
  ansible.builtin.shell: |
    export PATH="/root/.local/share/fnm:$PATH"
    eval "$(fnm env)"
    cd node_modules/.pnpm/better-sqlite3@12.4.1/node_modules/better-sqlite3
    node-gyp rebuild
  args:
    chdir: /opt/pra-proxmox/cms
    creates: /opt/pra-proxmox/cms/node_modules/.pnpm/better-sqlite3@12.4.1/node_modules/better-sqlite3/build/Release/better_sqlite3.node

- name: Build Strapi
  ansible.builtin.shell: |
    export PATH="/root/.local/share/fnm:$PATH"
    eval "$(fnm env)"
    pnpm build
  args:
    chdir: /opt/pra-proxmox/cms

- name: Deploy Strapi systemd service
  ansible.builtin.template:
    src: strapi.service.j2
    dest: /etc/systemd/system/strapi.service
    mode: "0644"
  notify: Restart Strapi

- name: Enable and start Strapi
  ansible.builtin.systemd:
    name: strapi
    enabled: true
    state: started
    daemon_reload: true
