---
- name: Setup Strapi CMS
  hosts: strapi
  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - git
          - curl
          - unzip
          - build-essential
          - python3
        state: present

    - name: Install fnm
      ansible.builtin.shell: curl -o- https://fnm.vercel.app/install | bash
      args:
        creates: /root/.local/share/fnm/fnm

    - name: Install Node.js via fnm
      ansible.builtin.shell: |
        export PATH="/root/.local/share/fnm:$PATH"
        eval "$(fnm env)"
        fnm install 24
      args:
        creates: /root/.local/share/fnm/node-versions/v24*

    - name: Install pnpm
      ansible.builtin.shell: |
        export PATH="/root/.local/share/fnm:$PATH"
        eval "$(fnm env)"
        npm install -g pnpm
      changed_when: false

    - name: Clone repository
      ansible.builtin.git:
        repo: https://github.com/nyantama0616/pra-proxmox.git
        dest: /opt/pra-proxmox
        version: main

    - name: Deploy Strapi .env
      ansible.builtin.template:
        src: templates/strapi.env.j2
        dest: /opt/pra-proxmox/cms/.env
        mode: "0600"

    - name: Install pnpm dependencies
      ansible.builtin.shell: |
        export PATH="/root/.local/share/fnm:$PATH"
        eval "$(fnm env)"
        pnpm install
      args:
        chdir: /opt/pra-proxmox/cms

    # Note: pnpm installではbetter-sqlite3のネイティブバインディング(.nodeファイル)が生成されない。
    # pnpm rebuildもpnpmの.pnpmストア構造の影響で正しくビルドされない。
    # そのため、パッケージディレクトリ内で直接node-gyp rebuildを実行する必要がある。
    - name: Rebuild better-sqlite3 native module
      ansible.builtin.shell: |
        export PATH="/root/.local/share/fnm:$PATH"
        eval "$(fnm env)"
        cd node_modules/.pnpm/better-sqlite3@12.4.1/node_modules/better-sqlite3
        npx node-gyp rebuild
      args:
        chdir: /opt/pra-proxmox/cms
        creates: /opt/pra-proxmox/cms/node_modules/.pnpm/better-sqlite3@12.4.1/node_modules/better-sqlite3/build/Release/better_sqlite3.node

    # Note: systemdからはfnmのシェル統合(eval "$(fnm env)")を利用できない。
    # defaultエイリアスを作成すると /root/.local/share/fnm/aliases/default/bin/ に
    # 安定したシンボリックリンクが生成されるため、systemdのサービスファイルから
    # fnm evalなしでNode.jsやpnpmのパスを参照できるようになる。
    - name: Create fnm default alias
      ansible.builtin.shell: |
        export PATH="/root/.local/share/fnm:$PATH"
        eval "$(fnm env)"
        fnm alias default 24
      args:
        creates: /root/.local/share/fnm/aliases/default

    - name: Build Strapi
      ansible.builtin.shell: |
        export PATH="/root/.local/share/fnm:$PATH"
        eval "$(fnm env)"
        pnpm build
      args:
        chdir: /opt/pra-proxmox/cms

    # --- Cloudflare Tunnel ---
    - name: Add Cloudflare GPG key
      ansible.builtin.shell: |
        curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg \
          -o /usr/share/keyrings/cloudflare-main.gpg
      args:
        creates: /usr/share/keyrings/cloudflare-main.gpg

    - name: Add Cloudflare apt repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main"
        filename: cloudflared
        state: present

    - name: Install cloudflared
      ansible.builtin.apt:
        name: cloudflared
        state: present
        update_cache: true

    - name: Create cloudflared config directory
      ansible.builtin.file:
        path: /etc/cloudflared
        state: directory
        mode: "0700"

    - name: Deploy cloudflared credentials
      ansible.builtin.template:
        src: templates/cloudflared-credentials.json.j2
        dest: /etc/cloudflared/credentials.json
        mode: "0600"
      notify: Restart cloudflared

    - name: Deploy cloudflared config
      ansible.builtin.template:
        src: templates/cloudflared-config.yml.j2
        dest: /etc/cloudflared/config.yml
        mode: "0644"
      notify: Restart cloudflared

    - name: Install cloudflared service
      ansible.builtin.shell: cloudflared --config /etc/cloudflared/config.yml service install
      args:
        creates: /etc/systemd/system/cloudflared.service

    - name: Enable and start cloudflared
      ansible.builtin.systemd:
        name: cloudflared
        enabled: true
        state: started
        daemon_reload: true

    # --- Strapi Service ---
    - name: Deploy Strapi systemd service
      ansible.builtin.template:
        src: templates/strapi.service.j2
        dest: /etc/systemd/system/strapi.service
        mode: "0644"
      notify: Restart Strapi

    - name: Enable and start Strapi
      ansible.builtin.systemd:
        name: strapi
        enabled: true
        state: started
        daemon_reload: true

  handlers:
    - name: Restart Strapi
      ansible.builtin.systemd:
        name: strapi
        state: restarted
        daemon_reload: true

    - name: Restart cloudflared
      ansible.builtin.systemd:
        name: cloudflared
        state: restarted
        daemon_reload: true
